name: CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: [self-hosted, macOS, X64]

    steps:
      - name: Debug secrets
        run: |
          echo "USERNAME SET = ${{ secrets.DOCKERHUB_USERNAME != '' }}"

      # 1. Checkout code repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2-3. Build and push image with Podman (Docker Hub)
      - name: Build & Push Docker Image with Podman
        run: |
          podman --version
          podman login docker.io -u "${DOCKERHUB_USERNAME}" -p "${DOCKERHUB_TOKEN}"
          podman build -t docker.io/${DOCKERHUB_USERNAME}/demo-app:latest -f ./Dockerfile .
          podman push docker.io/${DOCKERHUB_USERNAME}/demo-app:latest
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Checkout Kubernetes config repo
      - name: Checkout k8s config
        uses: actions/checkout@v3
        with:
          repository: Arshdeepdubey/nodejs-k8s-config
          # Ensure we have permission and a known branch
          token: ${{ secrets.K8S_CONFIG_TOKEN }}
          ref: main
          path: nodejs-k8s-config

      # 5. Diagnostic output (uses local kubeconfig on self-hosted runner)
      - name: kubectl version
        run: kubectl version --client --output=yaml

      - name: kubectl cluster-info
        run: kubectl cluster-info

      # 6. Deploy manifests to local cluster (kind)
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f nodejs-k8s-config/deployment.yaml
          kubectl apply -f nodejs-k8s-config/service.yaml
